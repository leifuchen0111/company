var FormWizard = function() {
    return {
        init: function() {
            if (!jQuery().bootstrapWizard) {
                return
            }
            function d(f) {
                if (!f.id) {
                    return f.text
                }
                return "<img class='flag' src='assets/img/flags/" + f.id.toLowerCase() + ".png'/>&nbsp;&nbsp;" + f.text
            }
            $("#country_list").select2({
                placeholder: "Select",
                allowClear: true,
                formatResult: d,
                formatSelection: d,
                escapeMarkup: function(f) {
                    return f
                }
            });
            var c = $("#submit_form");
            var b = $(".alert-error", c);
            var e = $(".alert-success", c);
            c.validate({
                doNotHideMessage: true,
                errorElement: "span",
                errorClass: "validate-inline",
                focusInvalid: false,
                messages: {
                    "payment[]": {
                        required: "Please select at least one option",
                        minlength: jQuery.format("Please select at least one option")
                    }
                },
                errorPlacement: function(g, f) {
                    if (f.attr("name") == "gender") {
                        g.addClass("no-left-padding").insertAfter("#form_gender_error")
                    } else {
                        if (f.attr("name") == "payment[]") {
                            g.addClass("no-left-padding").insertAfter("#form_payment_error")
                        } else {
                            g.insertAfter(f)
                        }
                    }
                },
                invalidHandler: function(f, g) {
                    e.hide();
                    b.show();
                    App.scrollTo(b, -200)
                },
                highlight: function(f) {
                    $(f).closest(".help-inline").removeClass("ok");
                    $(f).closest(".control-group").removeClass("success").addClass("error")
                },
                unhighlight: function(f) {
                    $(f).closest(".control-group").removeClass("error")
                },
                success: function(f) {
                    if (f.attr("for") == "gender" || f.attr("for") == "payment[]") {
                        f.closest(".control-group").removeClass("error").addClass("success");
                        f.remove()
                    } else {
                        f.addClass("valid ok").closest(".control-group").removeClass("error").addClass("success")
                    }
                },
                submitHandler: function(f) {
                    e.show();
                    b.hide()
                }
            });
            var a = function() {
                $(".display-value", c).each(function() {
                    var f = $('[name="' + $(this).attr("data-display") + '"]', c);
                    if (f.is(":text") || f.is("textarea")) {
                        $(this).html(f.val())
                    } else {
                        if (f.is("select")) {
                            $(this).html(f.find("option:selected").text())
                        } else {
                            if (f.is(":radio") && f.is(":checked")) {
                                $(this).html(f.attr("data-title"))
                            } else {
                                if ($(this).attr("data-display") == "card_expiry") {
                                    $(this).html($('[name="card_expiry_mm"]', c).val() + "/" + $('[name="card_expiry_yyyy"]', c).val())
                                } else {
                                    if ($(this).attr("data-display") == "payment") {
                                        var g = [];
                                        $('[name="payment[]"]').each(function() {
                                            g.push($(this).attr("data-title"))
                                        });
                                        $(this).html(g.join("<br>"))
                                    }
                                }
                            }
                        }
                    }
                })
            };
            $("#form_wizard_1").bootstrapWizard({
                nextSelector: ".button-next",
                previousSelector: ".button-previous",
                onTabClick: function(h, g, f) {
                    alert("on tab click disabled");
                    return false
                },
                onNext: function(l, k, h) {
                    e.hide();
                    b.hide();
                    console.log("next");
                    if (c.valid() == false) {
                        return false
                    }
                    var m = k.find("li").length;
                    var f = h + 1;
                    $(".step-title", $("#form_wizard_1")).text("Step " + (h + 1) + " of " + m);
                    jQuery("li", $("#form_wizard_1")).removeClass("done");
                    var j = k.find("li");
                    for (var g = 0; g < h; g++) {
                        jQuery(j[g]).addClass("done")
                    }
                    if (f == 1) {
                        $("#form_wizard_1").find(".button-previous").hide()
                    } else {
                        $("#form_wizard_1").find(".button-previous").show()
                    }
                    if (f >= m) {
                        $("#form_wizard_1").find(".button-next").hide();
                        $("#form_wizard_1").find(".button-submit").show();
                        a()
                    } else {
                        $("#form_wizard_1").find(".button-next").show();
                        $("#form_wizard_1").find(".button-submit").hide()
                    }
                    App.scrollTo($(".page-title"))
                },
                onPrevious: function(l, k, h) {
                    e.hide();
                    b.hide();
                    var m = k.find("li").length;
                    var f = h + 1;
                    $(".step-title", $("#form_wizard_1")).text("Step " + (h + 1) + " of " + m);
                    jQuery("li", $("#form_wizard_1")).removeClass("done");
                    var j = k.find("li");
                    for (var g = 0; g < h; g++) {
                        jQuery(j[g]).addClass("done")
                    }
                    if (f == 1) {
                        $("#form_wizard_1").find(".button-previous").hide()
                    } else {
                        $("#form_wizard_1").find(".button-previous").show()
                    }
                    if (f >= m) {
                        $("#form_wizard_1").find(".button-next").hide();
                        $("#form_wizard_1").find(".button-submit").show()
                    } else {
                        $("#form_wizard_1").find(".button-next").show();
                        $("#form_wizard_1").find(".button-submit").hide()
                    }
                    App.scrollTo($(".page-title"))
                },
                onTabShow: function(j, i, h) {
                    var k = i.find("li").length;
                    var g = h + 1;
                    var f = (g / k) * 100;
                    $("#form_wizard_1").find(".bar").css({
                        width: f + "%"
                    })
                }
            });
            $("#form_wizard_1").find(".button-previous").hide();
            $("#form_wizard_1 .button-submit").click(function() {
                $("#portlet-config .modal-header h3").html("新建站点");
                $("#portlet-config .modal-body p").html('<lable class="">站点正在建立中，请稍后。。。。</label>');
                $("#portlet-config").css("display", "block");




                var n = $("input[name='tpl_name']:checked").val();
                var h = $("input[name='gw_id']").val();
                var k = "";
                $("input[class*='myChecked']:checked").each(function() {
                    k += "," + $(this).val()
                });
                k = k.substr(1);
                var l = "ssid=" + k + "&tpl_style=" + n + "&gw_id=" + h;
                $.ajax({
                    url: "/We/Webbuild/webAdd",
                    type: "post",
                    dataType: "json",
                    data: l,
                    success: function(o) {
                        if (o.state == 0) {
                            $("#portlet-config .modal-body p").html('<lable class="alert-success">' + o.msg + "</label>")
                        } else {
                            $("#portlet-config .modal-body p").html('<lable class="alert-error">' + o.msg + "</label>")
                        }
                    },
                    error: function() {
                        console.log("服务器无响应，请联系运行商解决")
                    }
                })
            })
        }
    }
} ();