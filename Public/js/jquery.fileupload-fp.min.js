(function(a){if(typeof define==="function"&&define.amd){define(["jquery","load-image","canvas-to-blob","./jquery.fileupload"],a)}else{a(window.jQuery,window.loadImage)}}(function(a,b){a.widget("blueimp.fileupload",a.blueimp.fileupload,{options:{process:[],add:function(d,c){a(this).fileupload("process",c).done(function(){c.submit()})}},processActions:{load:function(c,f){var g=this,e=c.files[c.index],d=a.Deferred();if(window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype.toBlob&&(a.type(f.maxFileSize)!=="number"||e.size<f.maxFileSize)&&(!f.fileTypes||f.fileTypes.test(e.type))){b(e,function(h){if(!h.src){return d.rejectWith(g,[c])}c.img=h;d.resolveWith(g,[c])})}else{d.rejectWith(g,[c])}return d.promise()},resize:function(d,f){var e=d.img,c;f=a.extend({canvas:true},f);if(e){c=b.scale(e,f);if(c.width!==e.width||c.height!==e.height){d.canvas=c}}return d},save:function(d,h){if(!d.canvas){return d}var i=this,f=d.files[d.index],g=f.name,e=a.Deferred(),c=function(j){if(!j.name){if(f.type===j.type){j.name=f.name}else{if(f.name){j.name=f.name.replace(/\..+$/,"."+j.type.substr(6))}}}d.files[d.index]=j;e.resolveWith(i,[d])};if(d.canvas.mozGetAsFile){c(d.canvas.mozGetAsFile((/^image\/(jpeg|png)$/.test(f.type)&&g)||((g&&g.replace(/\..+$/,""))||"blob")+".png",f.type))}else{d.canvas.toBlob(c,f.type)}return e.promise()}},_processFile:function(e,f,g){var h=this,d=a.Deferred().resolveWith(h,[{files:e,index:f}]),c=d.promise();h._processing+=1;a.each(g.process,function(j,k){c=c.pipe(function(i){return h.processActions[k.action].call(this,i,k)})});c.always(function(){h._processing-=1;if(h._processing===0){h.element.removeClass("fileupload-processing")}});if(h._processing===1){h.element.addClass("fileupload-processing")}return c},process:function(c){var e=this,d=a.extend({},this.options,c);if(d.process&&d.process.length&&this._isXHRUpload(d)){a.each(c.files,function(g,f){e._processingQueue=e._processingQueue.pipe(function(){var h=a.Deferred();e._processFile(c.files,g,d).always(function(){h.resolveWith(e)});return h.promise()})})}return this._processingQueue},_create:function(){this._super();this._processing=0;this._processingQueue=a.Deferred().resolveWith(this).promise()}})}));