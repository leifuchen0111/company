(function(a){if(typeof define==="function"&&define.amd){define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],a)}else{a(window.jQuery,window.tmpl,window.loadImage)}}(function(a,c,b){a.widget("blueimp.fileupload",a.blueimp.fileupload,{options:{autoUpload:false,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:undefined,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5000000,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:true,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:undefined,prependFiles:false,dataType:"json",add:function(f,d){var i=a(this).data("blueimp-fileupload")||a(this).data("fileupload"),h=i.options,g=d.files;a(this).fileupload("process",d).done(function(){i._adjustMaxNumberOfFiles(-g.length);d.maxNumberOfFilesAdjusted=true;d.files.valid=d.isValidated=i._validate(g);d.context=i._renderUpload(g).data("data",d);h.filesContainer[h.prependFiles?"prepend":"append"](d.context);i._renderPreviews(d);i._forceReflow(d.context);i._transition(d.context).done(function(){if((i._trigger("added",f,d)!==false)&&(h.autoUpload||d.autoUpload)&&d.autoUpload!==false&&d.isValidated){d.submit()}})})},send:function(f,d){var g=a(this).data("blueimp-fileupload")||a(this).data("fileupload");if(!d.isValidated){if(!d.maxNumberOfFilesAdjusted){g._adjustMaxNumberOfFiles(-d.files.length);d.maxNumberOfFilesAdjusted=true}if(!g._validate(d.files)){return false}}if(d.context&&d.dataType&&d.dataType.substr(0,6)==="iframe"){d.context.find(".progress").addClass(!a.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%")}return g._trigger("sent",f,d)},done:function(g,d){var j=a(this).data("blueimp-fileupload")||a(this).data("fileupload"),h=j._getFilesFromResponse(d),i,f;if(d.context){d.context.each(function(l){var k=h[l]||{error:"Empty file upload result"},e=j._addFinishedDeferreds();if(k.error){j._adjustMaxNumberOfFiles(1)}j._transition(a(this)).done(function(){var m=a(this);i=j._renderDownload([k]).replaceAll(m);j._forceReflow(i);j._transition(i).done(function(){d.context=a(this);j._trigger("completed",g,d);j._trigger("finished",g,d);e.resolve();App.initFancybox();App.initUniform(".fileupload-checkbox")})})})}else{if(h.length){a.each(h,function(k,e){if(d.maxNumberOfFilesAdjusted&&e.error){j._adjustMaxNumberOfFiles(1)}else{if(!d.maxNumberOfFilesAdjusted&&!e.error){j._adjustMaxNumberOfFiles(-1)}}});d.maxNumberOfFilesAdjusted=true}i=j._renderDownload(h).appendTo(j.options.filesContainer);j._forceReflow(i);f=j._addFinishedDeferreds();j._transition(i).done(function(){d.context=a(this);j._trigger("completed",g,d);j._trigger("finished",g,d);f.resolve();App.initFancybox();App.initUniform(".fileupload-checkbox")})}},fail:function(g,d){var i=a(this).data("blueimp-fileupload")||a(this).data("fileupload"),h,f;if(d.maxNumberOfFilesAdjusted){i._adjustMaxNumberOfFiles(d.files.length)}if(d.context){d.context.each(function(j){if(d.errorThrown!=="abort"){var e=d.files[j];e.error=e.error||d.errorThrown||true;f=i._addFinishedDeferreds();i._transition(a(this)).done(function(){var k=a(this);h=i._renderDownload([e]).replaceAll(k);i._forceReflow(h);i._transition(h).done(function(){d.context=a(this);i._trigger("failed",g,d);i._trigger("finished",g,d);f.resolve();App.initFancybox();App.initUniform(".fileupload-checkbox")})})}else{f=i._addFinishedDeferreds();i._transition(a(this)).done(function(){a(this).remove();i._trigger("failed",g,d);i._trigger("finished",g,d);f.resolve();App.initFancybox();App.initUniform(".fileupload-checkbox")})}})}else{if(d.errorThrown!=="abort"){d.context=i._renderUpload(d.files).appendTo(i.options.filesContainer).data("data",d);i._forceReflow(d.context);f=i._addFinishedDeferreds();i._transition(d.context).done(function(){d.context=a(this);i._trigger("failed",g,d);i._trigger("finished",g,d);f.resolve()})}else{i._trigger("failed",g,d);i._trigger("finished",g,d);i._addFinishedDeferreds().resolve()}}},progress:function(f,d){if(d.context){var g=parseInt(d.loaded/d.total*100,10);d.context.find(".progress").attr("aria-valuenow",g).find(".bar").css("width",g+"%")}},progressall:function(g,f){var d=a(this),j=parseInt(f.loaded/f.total*100,10),i=d.find(".fileupload-progress"),h=i.find(".progress-extended");if(h.length){h.html((d.data("blueimp-fileupload")||d.data("fileupload"))._renderExtendedProgress(f))}i.find(".progress").attr("aria-valuenow",j).find(".bar").css("width",j+"%")},start:function(d){var f=a(this).data("blueimp-fileupload")||a(this).data("fileupload");f._resetFinishedDeferreds();f._transition(a(this).find(".fileupload-progress")).done(function(){f._trigger("started",d)})},stop:function(f){var g=a(this).data("blueimp-fileupload")||a(this).data("fileupload"),d=g._addFinishedDeferreds();a.when.apply(a,g._getFinishedDeferreds()).done(function(){g._trigger("stopped",f)});g._transition(a(this).find(".fileupload-progress")).done(function(){a(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%");a(this).find(".progress-extended").html("&nbsp;");d.resolve()})},destroy:function(f,d){var g=a(this).data("blueimp-fileupload")||a(this).data("fileupload");if(d.url){a.ajax(d);g._adjustMaxNumberOfFiles(1)}g._transition(d.context).done(function(){a(this).remove();g._trigger("destroyed",f,d)})}},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(d){if(!d){d=a.Deferred()}this._finishedUploads.push(d);return d},_getFinishedDeferreds:function(){return this._finishedUploads},_getFilesFromResponse:function(d){if(d.result&&a.isArray(d.result.files)){return d.result.files}return[]},_enableDragToDesktop:function(){var d=a(this),g=d.prop("href"),e=d.prop("download"),f="application/octet-stream";d.bind("dragstart",function(h){try{h.originalEvent.dataTransfer.setData("DownloadURL",[f,e,g].join(":"))}catch(i){}})},_adjustMaxNumberOfFiles:function(d){if(typeof this.options.maxNumberOfFiles==="number"){this.options.maxNumberOfFiles+=d;if(this.options.maxNumberOfFiles<1){this._disableFileInputButton()}else{this._enableFileInputButton()}}},_formatFileSize:function(d){if(typeof d!=="number"){return""}if(d>=1000000000){return(d/1000000000).toFixed(2)+" GB"}if(d>=1000000){return(d/1000000).toFixed(2)+" MB"}return(d/1000).toFixed(2)+" KB"},_formatBitrate:function(d){if(typeof d!=="number"){return""}if(d>=1000000000){return(d/1000000000).toFixed(2)+" Gbit/s"}if(d>=1000000){return(d/1000000).toFixed(2)+" Mbit/s"}if(d>=1000){return(d/1000).toFixed(2)+" kbit/s"}return d.toFixed(2)+" bit/s"},_formatTime:function(f){var d=new Date(f*1000),e=parseInt(f/86400,10);e=e?e+"d ":"";return e+("0"+d.getUTCHours()).slice(-2)+":"+("0"+d.getUTCMinutes()).slice(-2)+":"+("0"+d.getUTCSeconds()).slice(-2)},_formatPercentage:function(d){return(d*100).toFixed(2)+" %"},_renderExtendedProgress:function(d){return this._formatBitrate(d.bitrate)+" | "+this._formatTime((d.total-d.loaded)*8/d.bitrate)+" | "+this._formatPercentage(d.loaded/d.total)+" | "+this._formatFileSize(d.loaded)+" / "+this._formatFileSize(d.total)},_hasError:function(d){if(d.error){return d.error}if(this.options.maxNumberOfFiles<0){return"Maximum number of files exceeded"}if(!(this.options.acceptFileTypes.test(d.type)||this.options.acceptFileTypes.test(d.name))){return"Filetype not allowed"}if(this.options.maxFileSize&&d.size>this.options.maxFileSize){return"File is too big"}if(typeof d.size==="number"&&d.size<this.options.minFileSize){return"File is too small"}return null},_validate:function(d){var e=this,f=!!d.length;a.each(d,function(h,g){g.error=e._hasError(g);if(g.error){f=false}});return f},_renderTemplate:function(e,d){if(!e){return a()}var f=e({files:d,formatFileSize:this._formatFileSize,options:this.options});if(f instanceof a){return f}return a(this.options.templatesContainer).html(f).children()},_renderPreview:function(e,f){var h=this,g=this.options,d=a.Deferred();return((b&&b(e,function(i){f.append(i);h._forceReflow(f);h._transition(f).done(function(){d.resolveWith(f)});if(!a.contains(h.document[0].body,f[0])){d.resolveWith(f)}},{maxWidth:g.previewMaxWidth,maxHeight:g.previewMaxHeight,canvas:g.previewAsCanvas}))||d.resolveWith(f))&&d},_renderPreviews:function(d){var f=this,e=this.options;d.context.find(".preview span").each(function(i,g){var h=d.files[i];if(e.previewSourceFileTypes.test(h.type)&&(a.type(e.previewSourceMaxFileSize)!=="number"||h.size<e.previewSourceMaxFileSize)){f._processingQueue=f._processingQueue.pipe(function(){var j=a.Deferred(),k=a.Event("previewdone",{target:g});f._renderPreview(h,a(g)).done(function(){f._trigger(k.type,k,d);j.resolveWith(f)});return j.promise()})}});return this._processingQueue},_renderUpload:function(d){return this._renderTemplate(this.options.uploadTemplate,d)},_renderDownload:function(d){return this._renderTemplate(this.options.downloadTemplate,d).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(g){g.preventDefault();var d=a(g.currentTarget),h=d.closest(".template-upload"),f=h.data("data");if(f&&f.submit&&!f.jqXHR&&f.submit()){d.prop("disabled",true)}},_cancelHandler:function(f){f.preventDefault();var g=a(f.currentTarget).closest(".template-upload"),d=g.data("data")||{};if(!d.jqXHR){d.errorThrown="abort";this._trigger("fail",f,d)}else{d.jqXHR.abort()}},_deleteHandler:function(f){f.preventDefault();var d=a(f.currentTarget);this._trigger("destroy",f,a.extend({context:d.closest(".template-download"),type:"DELETE",dataType:this.options.dataType},d.data()))},_forceReflow:function(d){return a.support.transition&&d.length&&d[0].offsetWidth},_transition:function(e){var d=a.Deferred();if(a.support.transition&&e.hasClass("fade")){e.bind(a.support.transition.end,function(f){if(f.target===e[0]){e.unbind(a.support.transition.end);d.resolveWith(e)}}).toggleClass("in")}else{e.toggleClass("in");d.resolveWith(e)}return d},_initButtonBarEventHandlers:function(){var e=this.element.find(".fileupload-buttonbar"),d=this.options.filesContainer;this._on(e.find(".start"),{click:function(f){f.preventDefault();d.find(".start button").click()}});this._on(e.find(".cancel"),{click:function(f){f.preventDefault();d.find(".cancel button").click()}});this._on(e.find(".delete"),{click:function(f){f.preventDefault();d.find(".delete input:checked").parents(".checker").siblings("button").click();e.find(".toggle").prop("checked",false);jQuery.uniform.update(e.find(".toggle"))}});this._on(e.find(".toggle"),{change:function(f){d.find(".delete input").prop("checked",a(f.currentTarget).is(":checked"));jQuery.uniform.update(d.find(".delete input"))}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar button"),"click");this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_initEventHandlers:function(){this._super();this._on(this.options.filesContainer,{"click .start button":this._startHandler,"click .cancel button":this._cancelHandler,"click .delete button":this._deleteHandler});this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers();this._off(this.options.filesContainer,"click");this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",false).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",true).parent().addClass("disabled")},_initTemplates:function(){var d=this.options;d.templatesContainer=this.document[0].createElement(d.filesContainer.prop("nodeName"));if(c){if(d.uploadTemplateId){d.uploadTemplate=c(d.uploadTemplateId)}if(d.downloadTemplateId){d.downloadTemplate=c(d.downloadTemplateId)}}},_initFilesContainer:function(){var d=this.options;if(d.filesContainer===undefined){d.filesContainer=this.element.find(".files")}else{if(!(d.filesContainer instanceof a)){d.filesContainer=a(d.filesContainer)}}},_stringToRegExp:function(f){var e=f.split("/"),d=e.pop();e.shift();return new RegExp(e.join("/"),d)},_initRegExpOptions:function(){var d=this.options;if(a.type(d.acceptFileTypes)==="string"){d.acceptFileTypes=this._stringToRegExp(d.acceptFileTypes)}if(a.type(d.previewSourceFileTypes)==="string"){d.previewSourceFileTypes=this._stringToRegExp(d.previewSourceFileTypes)}},_initSpecialOptions:function(){this._super();this._initFilesContainer();this._initTemplates();this._initRegExpOptions()},_setOption:function(d,e){this._super(d,e);if(d==="maxNumberOfFiles"){this._adjustMaxNumberOfFiles(0)}},_create:function(){this._super();this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId");if(!this._processingQueue){this._processingQueue=a.Deferred().resolveWith(this).promise();this.process=function(){return this._processingQueue}}this._resetFinishedDeferreds()},enable:function(){var d=false;if(this.options.disabled){d=true}this._super();if(d){this.element.find("input, button").prop("disabled",false);this._enableFileInputButton()}},disable:function(){if(!this.options.disabled){this.element.find("input, button").prop("disabled",true);this._disableFileInputButton()}this._super()}})}));